services:
  test-auth:
    image: eclipse-temurin:21-jdk-alpine
    container_name: microstore-test-auth
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./services/auth:/app
      - ./services/auth/keys:/app/keys:ro
      - maven-cache:/root/.m2
    working_dir: /app
    command: sh -c "apk add --no-cache docker-cli && ./mvnw test"
    environment:
      DOCKER_HOST: unix:///var/run/docker.sock
      TESTCONTAINERS_RYUK_DISABLED: "true"
      TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE: /var/run/docker.sock
      TESTCONTAINERS_HOST_OVERRIDE: host.docker.internal
      AUTH_JWK_PATH: /app/keys/auth.jwks
      AUTH_JWK_KID: microstore-auth-dev
    extra_hosts:
      - "host.docker.internal:host-gateway"

  test-inventory:
    image: eclipse-temurin:21-jdk-alpine
    container_name: microstore-test-inventory
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./services/inventory:/app
      - maven-cache:/root/.m2
    working_dir: /app
    command: sh -c "apk add --no-cache docker-cli && ./mvnw test"
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      - TESTCONTAINERS_RYUK_DISABLED=true
      - TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE=/var/run/docker.sock
      - TESTCONTAINERS_HOST_OVERRIDE=host.docker.internal
    extra_hosts:
      - "host.docker.internal:host-gateway"

  test-orders:
    image: eclipse-temurin:21-jdk-alpine
    container_name: microstore-test-orders
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./services/orders:/app
      - maven-cache:/root/.m2
    working_dir: /app
    command: sh -c "apk add --no-cache docker-cli && ./mvnw test"
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      - TESTCONTAINERS_RYUK_DISABLED=true
      - TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE=/var/run/docker.sock
      - TESTCONTAINERS_HOST_OVERRIDE=host.docker.internal
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  maven-cache:
